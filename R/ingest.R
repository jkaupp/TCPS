#' Read the TCPS data contained within an SPSS file generated by Ken Meadows and transform the data into a tidy format
#'
#' @param file full file path to the SPSS .sav file
#'
#' @return a tidy data frame of TCPS data
#' @export
tidy_tcps_old <- function(file){

 data <- haven::read_sav(file) %>%
    dplyr::mutate_if(haven::is.labelled, function(x) haven::as_factor(x, levels = "label")) %>%
    dplyr::mutate(survey = stringi::stri_extract_first_regex(basename(file), "Faculty|Staff|Students")) %>%
    dplyr::select(.data$survey, .data$PartNum, dplyr::contains("agree"), dplyr::contains("imp"), dplyr::matches("Q\\d+[ai]\\b")) %>%
    purrr::map_df(~replace(.x, is.nan(.x), NA))

  srvy <- rlang::quo(unique(data[["survey"]]))

  selection <- dplyr::filter(.tcps_levers, .data$survey == UQ(srvy))

  selection$data <- list(data)

  purrr::pmap_df(selection, scale_helper) %>%
    dplyr::rename(part_num = .data$PartNum) %>%
    dplyr::distinct(.data$part_num, .data$item, .data$type, .data$scale, .keep_all = TRUE) %>%
    dplyr::ungroup() %>%
    split(.$type) %>%
    purrr::map(~dplyr::select(.x, -.data$type) %>% tidyr::spread( item, value)) %>%
    purrr::reduce(dplyr::left_join, by = c("survey", "part_num", "scale")) %>%
    dplyr::select(.data$survey, .data$part_num, .data$scale, .data$assessteach, .data$brengage, .data$impteach, .data$infrastruct, .data$instinit, .data$teachrec, dplyr::pull(.questions,.data$question))

}


#' Read the TCPS data contained within an SPSS file generated by Ken Meadows and transform the data into a tidy format
#'
#' @param file full file path to the SPSS .sav file
#'
#' @return a tidy data frame of TCPS data
#' @export
tidy_tcps_calgary <- function(file){

  data <- haven::read_spss(file) %>%
    dplyr::mutate_if(haven::is.labelled, function(x) haven::as_factor(x, levels = "values")) %>%
    dplyr::mutate_if(is.factor, as.character) %>%
    dplyr::mutate(survey = stringi::stri_extract_first_regex(basename(file), "Faculty|Staff|Student")) %>%
    dplyr::select(.data$survey, dplyr::contains("part", ignore.case = TRUE), dplyr::contains("lever", ignore.case = TRUE), dplyr::matches("Q\\d+_Q\\d+_\\d_\\d"), dplyr::matches("L\\d_[Ai]_Q\\d")) %>%
    dplyr::select(-contains("PRIORITY")) %>%
    purrr::map_df(~replace(.x, is.nan(.x), NA))

  data <- tidyr::gather(data, "item", "value", -survey, -dplyr::contains("part", ignore.case = TRUE), convert = FALSE)

  srvy <- rlang::quo(unique(data[["survey"]]))

  if(unique(data[["survey"]]) == "Faculty") {

    data <- dplyr::mutate(data, item = gsub("Q31_Q36", "Q31_Q37", .data$item),
                          item = gsub("Q37_Q42", "Q38_Q43", .data$item),
                          item = gsub("Q26_Q30_1_4", "Q26_Q30_1_3", .data$item),
                          item = gsub("Q26_Q30_1_5", "Q26_Q30_1_4", .data$item),
                          item = gsub("Q26_Q30_1_6", "Q26_Q30_1_5", .data$item),
                          item = gsub("Q26_Q30_2_4", "Q26_Q30_2_3", .data$item),
                          item = gsub("Q26_Q30_2_5", "Q26_Q30_2_4", .data$item),
                          item = gsub("Q26_Q30_2_6", "Q26_Q30_2_5", .data$item))
  }

  if(unique(data[["survey"]]) == "Staff") {

    data <- dplyr::mutate(data, item = gsub("Q12_Q15_1_2", "Q12_Q15_1_1", .data$item),
                          item = gsub("Q12_Q15_1_3", "Q12_Q15_1_2", .data$item),
                          item = gsub("Q12_Q15_1_4", "Q12_Q15_1_3", .data$item),
                          item = gsub("Q12_Q15_1_5", "Q12_Q15_1_4", .data$item),
                          item = gsub("Q12_Q15_2_2", "Q12_Q15_2_1", .data$item),
                          item = gsub("Q12_Q15_2_3", "Q12_Q15_2_2", .data$item),
                          item = gsub("Q12_Q15_2_4", "Q12_Q15_2_3", .data$item),
                          item = gsub("Q12_Q15_2_5", "Q12_Q15_2_4", .data$item),
                          item = gsub("Q16_Q21_1_3", "Q16_Q21_1_2", .data$item),
                          item = gsub("Q16_Q21_1_4", "Q16_Q21_1_3", .data$item),
                          item = gsub("Q16_Q21_1_5", "Q16_Q21_1_4", .data$item),
                          item = gsub("Q16_Q21_1_6", "Q16_Q21_1_5", .data$item),
                          item = gsub("Q16_Q21_1_7", "Q16_Q21_1_6", .data$item),
                          item = gsub("Q16_Q21_2_3", "Q16_Q21_2_2", .data$item),
                          item = gsub("Q16_Q21_2_4", "Q16_Q21_2_3", .data$item),
                          item = gsub("Q16_Q21_2_5", "Q16_Q21_2_4", .data$item),
                          item = gsub("Q16_Q21_2_6", "Q16_Q21_2_5", .data$item),
                          item = gsub("Q16_Q21_2_7", "Q16_Q21_2_6", .data$item),
                          item = gsub("Q34_Q38_1_6", "Q34_Q38_1_5", .data$item),
                          item = gsub("Q34_Q38_2_6", "Q34_Q38_2_5", .data$item))
  }



  if(unique(data[["survey"]]) == "Student") {

    data <- dplyr::mutate(data, item = gsub("Q18_Q23_1_6", "Q18_Q23_1_5", .data$item),
                          item = gsub("Q18_Q23_1_7", "Q18_Q23_1_6", .data$item),
                          item = gsub("Q18_Q23_2_6", "Q18_Q23_2_5", .data$item),
                          item = gsub("Q18_Q23_2_7", "Q18_Q23_2_6", .data$item),
                          item = gsub("Q24_Q28_1_5", "Q24_Q28_1_3", .data$item),
                          item = gsub("Q24_Q28_1_6", "Q24_Q28_1_4", .data$item),
                          item = gsub("Q24_Q28_1_7", "Q24_Q28_1_5", .data$item),
                          item = gsub("Q24_Q28_2_5", "Q24_Q28_2_3", .data$item),
                          item = gsub("Q24_Q28_2_6", "Q24_Q28_2_4", .data$item),
                          item = gsub("Q24_Q28_2_7", "Q24_Q28_2_5", .data$item),
                          item = gsub("Q29_Q34_1_7", "Q29_Q34_1_6", .data$item),
                          item = gsub("Q29_Q34_2_7", "Q29_Q34_2_6", .data$item)
    )
  }


   data <- data %>%
    tidyr::separate(item, c("qstart", "qend", "scale", "idx"), sep = "\\_", remove = FALSE, fill = "right") %>%
    dplyr::mutate(idx = ifelse(is.na(.data$idx) & !grepl("Lever", .data$item), stringi::stri_extract_last_regex(.data$item, "\\d") ,idx)) %>%
    dplyr::mutate(scale = ifelse(.data$scale == 1, "agreement", "importance"),
                  scale = dplyr::case_when(grepl("A\\b", .data$item) ~ "agreement",
                                           grepl("i\\b", .data$item) ~ "importance",
                                           TRUE ~ .data$scale)) %>%
    dplyr::mutate(qstart = readr::parse_number(.data$qstart)) %>%
    dplyr::mutate(item = ifelse(grepl("Lever", .data$item), .data$item, glue::glue("Q{.data$qstart + (as.numeric(idx) -1)}"))) %>%
    dplyr::rename(part_num = .data$PartNum) %>%
    dplyr::mutate(item = gsub("[Ai]\\b", "", .data$item),
                  item = ifelse(grepl("Lever", .data$item), .lever_alias[item], .data$item)) %>%
    dplyr::select(.data$survey, .data$part_num, .data$scale, .data$item, .data$value) %>%
    tidyr::spread("item", "value", drop = TRUE, convert = TRUE)


  selection <- dplyr::filter(.tcps_levers, .data$survey == UQ(srvy))

  selection$data <- list(data)



  # Need to update this to be V2 specific
  purrr::pmap_df(selection, scale_helper) %>%
    dplyr::distinct(.data$part_num, .data$item, .data$type, .data$scale, .keep_all = TRUE) %>%
    dplyr::ungroup() %>%
    split(.$type) %>%
    purrr::map(~dplyr::select(.x, -.data$type) %>% tidyr::spread( item, value)) %>%
    purrr::reduce(dplyr::left_join, by = c("survey", "part_num", "scale")) %>%
    dplyr::select(.data$survey, .data$part_num, .data$scale, .data$assessteach, .data$brengage, .data$impteach, .data$infrastruct, .data$instinit, .data$teachrec, dplyr::num_range("Q",1:50))

}

#' Read the TCPS data contained within an SPSS file generated by Ken Meadows and transform the data into a tidy format
#'
#' @param file full file path to the SPSS .sav file
#'
#' @return a tidy data frame of TCPS data
#' @export
tidy_tcps_windsor <- function(file){

  data <- haven::read_spss(file) %>%
    dplyr::mutate_if(haven::is.labelled, function(x) haven::as_factor(x, levels = "values")) %>%
    dplyr::mutate_if(is.factor, as.character) %>%
    dplyr::mutate(survey = stringi::stri_extract_first_regex(basename(file), "Faculty|Staff|Student")) %>%
    dplyr::select(.data$survey, dplyr::contains("part", ignore.case = TRUE), dplyr::contains("lever", ignore.case = TRUE), dplyr::matches("Q\\d+_Q\\d+_\\d_\\d"), dplyr::matches("L\\d_[Ai]_Q\\d")) %>%
    dplyr::select(-contains("PRIORITY")) %>%
    purrr::map_df(~replace(.x, is.nan(.x), NA)) %>%
    janitor::clean_names()

  data <- tidyr::gather(data, "item", "value", -survey, -dplyr::contains("part", ignore.case = TRUE), convert = FALSE)

  srvy <- rlang::quo(unique(data[["survey"]]))



  data <- data %>%
    dplyr::mutate(scale = dplyr::case_when(grepl("a\\b", .data$item, ignore.case = TRUE) ~ "agreement",
                                           grepl("_a_", .data$item, ignore.case = TRUE) ~ "agreement",
                                           grepl("_i_", .data$item, ignore.case = TRUE) ~ "importance",
                                           grepl("i\\b", .data$item, ignore.case = TRUE) ~ "importance"),
                  item = ifelse(grepl("lever", .data$item, ignore.case = TRUE), stringi::stri_extract_first_regex(.data$item, "lever\\d"),  gsub("_[ai]_", "_", .data$item, ignore.case = TRUE)),
                  item = gsub("l(\\d)", "lever\\1", .data$item)) %>%
    dplyr::select(.data$survey, part_num = .data$participant, .data$scale, .data$item, .data$type, .data$value) %>%
    tidyr::spread("item", "value", drop = TRUE, convert = TRUE)

}

if(getRversion() >= "2.15.1")  utils::globalVariables(c("."))
